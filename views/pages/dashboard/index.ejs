<%- include("../../partials/head.ejs") %>

  <body id="page-top">
    <div id="wrapper">
      <%- include("../../partials/sidebar.ejs") %>
        <div id="content-wrapper" class="d-flex flex-column">
          <div id="content">
            <%- include("../../partials/topbar.ejs") %>
              <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                  <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                  <% if(user.data.tokenGrowatt) { %>
                    <form method="post">
                      <input type="text" name="type" value="RELOAD_GROWATT" style="display: none;">
                      <input type="text" name="userID" value="<%=user.key%>" style="display: none;">
                      <input type="text" name="token" value="<%=user.data.tokenGrowatt%>" style="display: none;">

                      <button type="submit" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                        <i class="fas fa-download fa-sm text-white-50"></i>
                        Atualizar dados Growatt
                      </button>
                    </form>

                    <% } else { %>
                      <a href="/conta" class="d-none d-sm-inline-block btn btn-sm btn-danger shadow-sm"><i
                          class="fas fa-download fa-sm text-white-50"></i> Adicionar TOKEN Growatt</a>
                      <%}%>
                </div>
                <% if(user.data.tokenGrowatt) { %>
                  <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <p>
                      Última vez que os dados da Growatt foram atualizados:
                      <b>
                        <script>
                          document.write(moment("<%=growatt.token.lastUse%>").fromNow());
                        </script>
                      </b>
                    </p>
                  </div>
                  <% } %>
                    <div class="row">

                      <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                          <div class="card-body">
                            <div class="row no-gutters align-items-center">
                              <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                  Projetos Registrados</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                  <%=projects.length%>
                                </div>
                              </div>
                              <div class="col-auto">
                                <i class="fas fa-solar-panel fa-2x text-gray-300"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <% if(user.data.tokenGrowatt) { %>
                        <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Sistemas Growatt</div>
                                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    <%=growatt.plantList.data.data.count || 0%>
                                  </div>
                                </div>
                                <div class="col-auto">
                                  <i class="fas fa-wifi fa-2x text-gray-300"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                          <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                              <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Geração Growatt Total</div>
                                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    <%=kwh%>kW/h
                                  </div>
                                </div>
                                <div class="col-auto">
                                  <i class="fas fa-bolt fa-2x text-gray-300"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <% } %>

                          <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                              <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                      Clientes Registrados</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                      <%=customers.length%>
                                    </div>
                                  </div>
                                  <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                              <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                      Funcionários Registrados</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                      <%=staffs.length%>
                                    </div>
                                  </div>
                                  <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-danger shadow h-100 py-2">
                              <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                      Chamados pendentes</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                      <%=surveys.filter(i=> !i.data.finished && !i.data.accepted).length%>
                                    </div>
                                  </div>
                                  <div class="col-auto">
                                    <i class="fas fa-exclamation fa-2x text-gray-300"></i>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-danger shadow h-100 py-2">
                              <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                      Chamados em execução</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                      <%=surveys.filter(i=> !i.data.finished && i.data.accepted).length%>
                                    </div>
                                  </div>
                                  <div class="col-auto">
                                    <i class="fas fa-exclamation fa-2x text-gray-300"></i>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-danger shadow h-100 py-2">
                              <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                  <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                      Reclamações</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                      <%=complaints.length%>
                                    </div>
                                  </div>
                                  <div class="col-auto">
                                    <i class="fas fa-exclamation fa-2x text-gray-300"></i>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                    </div>


                    <div class="row">
                      <div class="col-lg-6 mb-4">

                        <div class="card shadow mb-4">
                          <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Lembretes</h6>
                          </div>
                          <div class="card-body">

                            <% if(stickNotes.length===0) {%>
                              <a href="#" class="btn btn-primary" style="width: 100%">
                                <span class="icon text-white-50">
                                  <i class="fas fa-info"></i>
                                </span>
                                <span class="text">Sem lembretes</span>
                              </a>
                              <%} else {%>
                                <% stickNotes.forEach(i=> { %>
                                  <a href="<%i.url%>" class="btn btn-<%i.style%>" style="width: 100%">
                                    <span class="icon text-white-50">
                                      <i class="fas fa-<%i.icon%>"></i>
                                    </span>
                                    <span class="text">
                                      <%i.message%>
                                    </span>
                                  </a>
                                  <% }); %>
                                    <% }%>
                          </div>
                        </div>

                        <!-- Project Card -->
                        <div class="card shadow mb-4">
                          <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Projetos</h6>
                          </div>
                          <div class="card-body">
                            <h4 class="small font-weight-bold">Projetos pendentes<span class="float-right">
                                <%=projects.filter(i=> i.data.Status !== 'finalizado').length * 100/ projects.length%>%
                              </span></h4>
                            <div class="progress mb-4">
                              <div class="progress-bar bg-danger" role="progressbar"
                                style="width: <%=projects.filter(i => i.data.Status !== 'finalizado').length * 100/ projects.length%>%"
                                aria-valuenow="<%=projects.filter(i => i.data.Status !== 'finalizado').length * 100/ projects.length%>"
                                aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <h4 class="small font-weight-bold">Projetos finalizados <span class="float-right">
                                <%=projects.filter(i=> i.data.Status === "finalizado").length * 100/ projects.length%>%
                              </span></h4>
                            <div class="progress mb-4">
                              <div class="progress-bar bg-info" role="progressbar"
                                style="width: <%=projects.filter(i => i.data.Status === " finalizado").length * 100/
                                projects.length%>%" aria-valuenow="<%=projects.filter(i=> i.data.Status ===
                                  "finalizado").length * 100/ projects.length%>" aria-valuemin="0" aria-valuemax="100">
                              </div>
                            </div>
                          </div>
                        </div>

                        <!--card-->
                        <div class="card shadow mb-4">
                          <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Mapa dos projetos</h6>
                          </div>
                          <div class="card-body">
                            <div class="mapa" id="mapa" style="width: 100%; height: 400px;">
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-6 mb-4">

                        <div class="card shadow mb-4">
                          <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Connect de Empresas</h6>
                          </div>
                          <div class="card-body">
                            <div class="text-center">
                              <img class="img-fluid px-3 px-sm-4 mt-3 mb-4" style="width: 25rem;"
                                src="img/undraw_posting_photo.svg" alt="...">
                            </div>
                            <p>Estamos arduamente trabalhando no desenvolvimento das aplicações e com
                              uma qualidade sem igual para fornecer elementos e gestão de qualidade
                              para sua empresa. Baixe nossos aplicativos e sempre realize os registros
                              necessários para ter uma boa experiência com o serviço.</p>
                            <a target="_blank" rel="nofollow" href="https://www.dlwalt.com/">D | Walt
                              site raíz &rarr;</a>
                          </div>
                        </div>
                      </div>
                    </div>
              </div>
          </div>
          <%- include("../../partials/footer.ejs") %>
        </div>
    </div>
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="/js/sb-admin-2.min.js"></script>
    <%if(message) {%>
      <script>
        swal("<%=message.title%>", "<%=message.description%>", "<%=message.type%>");
      </script>
      <%}%>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
          integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
          crossorigin=""></script>
        <script>
          let map = L.map('mapa').setView(["-8.76", "-63.8"], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);
          let LeafIcon = L.Icon.extend({
            options: {
              iconSize: [60, 60],
            }
          });
          let systemIcon = new LeafIcon({
            iconUrl: 'https://static.wixstatic.com/media/2f7194_fa185c61f22e43f193b873822dec1beb~mv2.png/v1/fill/w_426,h_410,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/Placa-Painel-Solar.png'
          });

<% projects.forEach(item => { %>
            L.marker(["<%=item.data.coords.split(", ")[0]%>", "<%=item.data.coords.split(", ")[1]%>"], {
              icon: systemIcon
            }).bindPopup('<%=item.data.apelidoProjeto%>').addTo(map);
    <% }) %>

        </script>

  </body>


  </html>